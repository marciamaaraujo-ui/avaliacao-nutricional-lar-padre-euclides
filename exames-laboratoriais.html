<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exames Laboratoriais - ILPI</title>
<link rel="stylesheet" href="style.css">
<script src="app.js"></script>
</head>

<body>

<div class="navbar">
  <div class="navbar-inner">
    <img src="logo.png" class="logo">
    <div class="links">
      <a href="ficha-completa.html">Ficha</a>
      <a href="exames-laboratoriais.html">Exames</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="relatorio.html">Direção</a>
    </div>
  </div>
</div>

<div class="container">

<h1>Painel de Exames Laboratoriais</h1>

<h2>Seleção do Residente</h2>

<div class="grid">

<div>
<label>Nome do Residente</label>
<input type="text" id="nomeResidente">
</div>

</div>

<h2>Inflamação</h2>

<div class="grid">

<div>
<label>Albumina (g/dL)</label>
<input type="number" step="0.1" id="albumina">
</div>

<div>
<label>PCR (mg/L)</label>
<input type="number" step="0.1" id="pcr">
</div>

<div>
<label>Índice Inflamatório (PCR/Albumina)</label>
<input type="text" id="indiceInflamatorio" readonly>
</div>

</div>

<h2>Função Renal</h2>

<div class="grid">

<div>
<label>Creatinina (mg/dL)</label>
<input type="number" step="0.1" id="creatinina">
</div>

<div>
<label>Idade</label>
<input type="number" id="idadeMed">
</div>

<div>
<label>Sexo</label>
<select id="sexoMed">
<option>Feminino</option>
<option>Masculino</option>
</select>
</div>

<div>
<label>TFGe (mL/min)</label>
<input type="text" id="tfge" readonly>
</div>

<div>
<label>Classificação Renal</label>
<input type="text" id="riscoRenal" readonly>
</div>

</div>

<br><br>

<button onclick="integrarExames()">Integrar ao Diagnóstico</button>

</div>

<script>

function integrarExames(){

    const residente = nomeResidente.value.trim();

    if(!residente){
        alert("Informe o nome do residente.");
        return;
    }

    const banco = obterBanco();

    if(!banco[residente]){
        alert("Residente não encontrado no sistema.");
        return;
    }

    const historico = banco[residente];
    const ultimo = historico[historico.length - 1];

    const albuminaVal = Number(albumina.value);
    const pcrVal = Number(pcr.value);
    const creatVal = Number(creatinina.value);
    const idadeVal = Number(idadeMed.value);
    const sexoVal = sexoMed.value;

    if(isNaN(albuminaVal) && isNaN(pcrVal) && isNaN(creatVal)){
        alert("Preencha pelo menos um exame.");
        return;
    }

    /* =========================
       ÍNDICE INFLAMATÓRIO
    ========================= */

    let ratio = 0;

    if(albuminaVal > 0){
        ratio = pcrVal / albuminaVal;
        indiceInflamatorio.value = ratio.toFixed(2);
        ultimo.indiceInflamatorio = Number(ratio.toFixed(2));
    } else {
        indiceInflamatorio.value = "—";
    }

    /* =========================
       SCORE BIOQUÍMICO
    ========================= */

    let scoreBio = 0;

    if(albuminaVal > 0 && albuminaVal < 3.5) scoreBio += 2;
    if(pcrVal > 5) scoreBio += 2;

    ultimo.scoreBio = scoreBio;

    /* =========================
       TFGe (CKD-EPI)
    ========================= */

    let tfgeCalc = 0;
    let risco = "Não avaliado";

    if(creatVal > 0 && idadeVal > 0){

        if(creatVal < 0.3){
            alert("Creatinina inválida.");
            return;
        }

        let k = (sexoVal === "Feminino") ? 0.7 : 0.9;
        let a = (sexoVal === "Feminino") ? -0.329 : -0.411;

        tfgeCalc = 141 *
            Math.min(creatVal/k,1)**a *
            Math.max(creatVal/k,1)**-1.209 *
            (0.993**idadeVal) *
            (sexoVal === "Feminino" ? 1.018 : 1);

        tfgeCalc = Number(tfgeCalc.toFixed(1));

        if(tfgeCalc >= 90) risco = "Função Preservada";
        else if(tfgeCalc >= 60) risco = "Leve redução";
        else if(tfgeCalc >= 30) risco = "Redução Moderada";
        else risco = "Redução Grave";

        tfge.value = tfgeCalc;
        riscoRenal.value = risco;

        ultimo.tfge = tfgeCalc;
        ultimo.riscoRenal = risco;
    }

    /* =========================
       SCORE FINAL INTEGRADO
    ========================= */

    const scoreFinal = ultimo.icn + scoreBio;

    ultimo.classificacao = classificarICN(scoreFinal);

    /* =========================
       PARECER CLÍNICO
    ========================= */

    let parecer = "Avaliação integrada: ";

    if(scoreBio > 0){
        parecer += "Presença de inflamação clínica. ";
    }

    if(risco === "Redução Moderada" || risco === "Redução Grave"){
        parecer += "Comprometimento renal relevante. ";
    }

    if(scoreFinal < 3){
        parecer += "Quadro clínico estável.";
    }

    ultimo.parecerClinico = parecer;

    salvarBanco(banco);

    alert("Exames integrados com sucesso ao residente.");

}

</script>

</body>
</html>
