<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Painel Nutricional</title>
    <link rel="stylesheet" href="style.css">
</head>
<body onload="renderizarDashboard()">

    <div class="navbar">
        <img src="logo.png" alt="Logo" style="height: 60px; margin-right: 30px;">
        <a href="index.html">Nova Avalia√ß√£o</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="ficha-completa.html">Ficha Cl√≠nica</a>
        <a href="exames-laboratoriais.html">Exames</a>
    </div>

    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
        <header>
            <h1>Painel de Controlo Nutricional</h1>
            <p>Monitoriza√ß√£o e estat√≠sticas dos residentes</p>
        </header>

        <div class="grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px;">
            <div style="background: #fff; padding: 30px; border-radius: 15px; border-top: 5px solid var(--primary-color); text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <label>Residentes Avaliados</label>
                <p id="statTotal" style="font-size: 2.5rem; font-weight: bold; margin: 0;">0</p>
            </div>
            <div style="background: #fff; padding: 30px; border-radius: 15px; border-top: 5px solid #e67e22; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <label>Alto Risco (ICN)</label>
                <p id="statRisco" style="font-size: 2.5rem; font-weight: bold; color: #e67e22; margin: 0;">0</p>
            </div>
            <div style="background: #fff; padding: 30px; border-radius: 15px; border-top: 5px solid var(--secondary-color); text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <label>M√©dia IMC</label>
                <p id="statImc" style="font-size: 2.5rem; font-weight: bold; margin: 0;">0</p>
            </div>
        </div>

        <section style="margin-top: 50px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h3>Hist√≥rico de Acompanhamento</h3>
                <button class="btn-save" onclick="exportarExcel()" style="width: auto; padding: 12px 25px; margin: 0; font-size: 1rem; cursor: pointer; background-color: #27ae60; color: white; border: none; border-radius: 8px;">
                    üìä Exportar Planilha Excel
                </button>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <thead>
                    <tr style="background: #f8f9fa; text-align: left;">
                        <th style="padding: 20px; border-bottom: 2px solid var(--primary-color);">Residente</th>
                        <th style="padding: 20px; border-bottom: 2px solid var(--primary-color);">Data</th>
                        <th style="padding: 20px; border-bottom: 2px solid var(--primary-color);">MNA (0-30)</th>
                        <th style="padding: 20px; border-bottom: 2px solid var(--primary-color);">NRS (0-7)</th>
                        <th style="padding: 20px; border-bottom: 2px solid var(--primary-color);">Status ICN</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </section>
    </div>

    <script src="app.js"></script>
    <script>
        function renderizarDashboard() {
            const banco = obterBanco();
            const corpo = document.getElementById("corpoTabela");
            corpo.innerHTML = "";
            let totalRes = 0, totalRisco = 0, somaImc = 0;

            Object.keys(banco).sort().forEach(nome => {
                const avais = banco[nome].avaliacoes;
                if(avais.length > 0) {
                    totalRes++;
                    const u = avais[avais.length - 1];
                    somaImc += parseFloat(u.imc) || 0;
                    if(u.classIcn === "Alto Risco Cl√≠nico") totalRisco++;

                    const corStatus = u.classIcn === "Baixo Risco" ? "#27ae60" : (u.classIcn === "Risco Moderado" ? "#f39c12" : "#e74c3c");

                    corpo.innerHTML += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 20px;"><strong>${nome}</strong></td>
                            <td style="padding: 20px;">${u.data}</td>
                            <td style="padding: 20px;">${u.mna || '-'} pts</td>
                            <td style="padding: 20px;">${u.nrs || '-'} pts</td>
                            <td style="padding: 20px; font-weight: bold; color: ${corStatus}">${u.classIcn}</td>
                        </tr>`;
                }
            });

            document.getElementById("statTotal").innerText = totalRes;
            document.getElementById("statRisco").innerText = totalRisco;
            document.getElementById("statImc").innerText = totalRes > 0 ? (somaImc / totalRes).toFixed(1) : "0";
        }

        // Fun√ß√£o de exporta√ß√£o melhorada
        function exportarExcel() {
            const b = obterBanco();
            // Cabe√ßalho da planilha
            let csv = "Residente;Data;IMC;MNA;NRS;ICN;Status\n";
            
            Object.keys(b).forEach(n => { 
                b[n].avaliacoes.forEach(a => { 
                    // Substitui v√≠rgulas por pontos para n√£o quebrar o CSV e garante o uso de ponto e v√≠rgula como separador
                    csv += `${n};${a.data};${a.imc || ''};${a.mna || ''};${a.nrs || ''};${a.icn || ''};${a.classIcn}\n`; 
                }); 
            });

            // Criar o arquivo para download (Blob)
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            
            const dataHoje = new Date().toISOString().slice(0,10);
            link.setAttribute("href", url);
            link.setAttribute("download", `relatorio_nutricional_${dataHoje}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
