<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Lar Padre Euclides</title>
    <link rel="stylesheet" href="style.css">
</head>
<body onload="renderizarDashboard()">

    <div class="navbar">
        <img src="logo.png" alt="Logo" style="height:50px; margin-right:20px;">
        <a href="index.html">Nova Avalia√ß√£o</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="ficha-completa.html">Ficha Cl√≠nica</a>
        <a href="exames-laboratoriais.html">Exames</a>
    </div>

    <div class="container" style="max-width: 1100px;">
        <header>
            <h1>Painel de Controle Nutricional</h1>
            <p>Estat√≠sticas e Monitoramento de Residentes</p>
        </header>

        <div class="grid">
            <div style="background: #fff; padding: 20px; border-radius: 8px; border-top: 4px solid var(--primary-color); text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <h4>Residentes Avaliados</h4>
                <p id="statTotal" style="font-size: 1.8rem; font-weight: bold; margin: 10px 0;">0</p>
            </div>
            <div style="background: #fff; padding: 20px; border-radius: 8px; border-top: 4px solid #e67e22; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <h4>Alto Risco (ICN)</h4>
                <p id="statRisco" style="font-size: 1.8rem; font-weight: bold; color: #e67e22; margin: 10px 0;">0</p>
            </div>
        </div>

        <section>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>Lista de Acompanhamento</h3>
                <button class="btn-save" onclick="exportarExcel()" style="width: auto; padding: 10px 20px; margin:0;">üì• Exportar Excel</button>
            </div>
            
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding:12px; border-bottom:2px solid var(--primary-color);">Residente</th>
                        <th style="padding:12px; border-bottom:2px solid var(--primary-color);">MNA</th>
                        <th style="padding:12px; border-bottom:2px solid var(--primary-color);">NRS-2002</th>
                        <th style="padding:12px; border-bottom:2px solid var(--primary-color);">ICN (Risco)</th>
                        <th style="padding:12px; border-bottom:2px solid var(--primary-color);">A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </section>
    </div>

    <script src="app.js"></script>
    <script>
        function renderizarDashboard() {
            const banco = obterBanco();
            const corpo = document.getElementById("corpoTabela");
            corpo.innerHTML = "";
            let totalRes = 0, totalRisco = 0;

            Object.keys(banco).sort().forEach(nome => {
                const avais = banco[nome].avaliacoes;
                if(avais.length > 0) {
                    totalRes++;
                    const u = avais[avais.length - 1];
                    if(u.classIcn === "Alto Risco Cl√≠nico") totalRisco++;

                    corpo.innerHTML += `
                        <tr>
                            <td style="padding:12px; border-bottom:1px solid #eee;"><strong>${nome}</strong></td>
                            <td style="padding:12px; border-bottom:1px solid #eee;">${classificarMNA(u.mna)}</td>
                            <td style="padding:12px; border-bottom:1px solid #eee;">${classificarNRS(u.nrs)}</td>
                            <td style="padding:12px; border-bottom:1px solid #eee; font-weight:bold; color:${u.classIcn.includes('Alto') ? 'red' : 'green'}">
                                ${u.classIcn}
                            </td>
                            <td style="padding:12px; border-bottom:1px solid #eee;">
                                <button onclick="remover('${nome}')" style="color:red; background:none; border:none; cursor:pointer;">Excluir</button>
                            </td>
                        </tr>`;
                }
            });
            document.getElementById("statTotal").innerText = totalRes;
            document.getElementById("statRisco").innerText = totalRisco;
        }

        function remover(n) { if(confirm("Apagar hist√≥rico de " + n + "?")) { const b = obterBanco(); delete b[n]; salvarBanco(b); renderizarDashboard(); } }
        
        function exportarExcel() {
            const b = obterBanco();
            let csv = "data:text/csv;charset=utf-8,\uFEFFResidente;Data;IMC;ICN;Status\n";
            Object.keys(b).forEach(n => { b[n].avaliacoes.forEach(a => { csv += `${n};${a.data};${a.imc};${a.icn};${a.classIcn}\n`; }); });
            window.location.href = encodeURI(csv);
        }
    </script>
</body>
</html>
