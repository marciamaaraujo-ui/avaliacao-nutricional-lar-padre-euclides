<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ficha Clínica Completa - ILPI</title>
<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/jspdf"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>
</head>

<body>

<div class="navbar">
  <div class="navbar-inner">
    <img src="logo.png" class="logo">
    <div class="links">
      <a href="index.html">Ficha Simplificada</a>
      <a href="ficha-completa.html">Ficha Completa</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="metodologia.html">Metodologia</a>
    </div>
  </div>
</div>

<div class="container">

<h1>Ficha Clínica Completa ILPI</h1>

<h2>Identificação</h2>

<div class="grid">

<div>
<label>Setor</label>
<select>
<option>Suíte</option>
<option>Enfermaria</option>
</select>
</div>

<div>
<label>Data da Avaliação</label>
<input type="date" id="dataAvaliacao">
</div>

<div>
<label>Nome</label>
<input type="text" id="nome">
</div>

<div>
<label>Data de Admissão</label>
<input type="date">
</div>

<div>
<label>Data de Nascimento</label>
<input type="date" id="dataNascimento" onchange="calcularIdade()">
</div>

<div>
<label>Idade</label>
<input type="text" id="idade" readonly>
</div>

<div>
<label>Gênero</label>
<select>
<option>Feminino</option>
<option>Masculino</option>
</select>
</div>

</div>

<h2>Antropometria</h2>

<div class="grid">

<div>
<label>Altura (m)</label>
<input type="number" step="0.01" id="altura" oninput="calculosAntropometricos()">
</div>

<div>
<label>Peso Atual (kg)</label>
<input type="number" step="0.1" id="peso" oninput="calculosAntropometricos()">
</div>

<div>
<label>Peso Habitual (kg)</label>
<input type="number" step="0.1">
</div>

<div>
<label>IMC (kg/m²)</label>
<input type="text" id="imc" readonly>
</div>

<div>
<label>Classificação IMC</label>
<input type="text" id="classImc" readonly>
</div>

</div>

<h2>Triagem Nutricional</h2>

<div class="grid">

<div>
<label>MNA (0–14)</label>
<input type="number" id="mna" min="0" max="14">
</div>

<div>
<label>NRS 2002</label>
<input type="number" id="nrs" min="0" max="7">
</div>

<div>
<label>ICN</label>
<input type="text" id="icn" readonly>
</div>

<div>
<label>Classificação Final</label>
<input type="text" id="classificacaoFinal" readonly>
</div>

</div>

<br><br>

<button onclick="salvarAvaliacao()">Salvar e Integrar ao Dashboard</button>
<button onclick="gerarPDF()">Gerar PDF Institucional</button>

</div>

<script>

function calcularIdade(){
  const nasc=new Date(document.getElementById("dataNascimento").value);
  const hoje=new Date();
  let idade=hoje.getFullYear()-nasc.getFullYear();
  if(hoje.getMonth()<nasc.getMonth() ||
    (hoje.getMonth()==nasc.getMonth() && hoje.getDate()<nasc.getDate())){
      idade--;
  }
  document.getElementById("idade").value=idade+" anos";
}

function calculosAntropometricos(){

  const p=parseFloat(document.getElementById("peso").value)||0;
  const a=parseFloat(document.getElementById("altura").value)||0;

  if(p>0 && a>0){
    const imcVal=(p/(a*a)).toFixed(2);
    document.getElementById("imc").value=imcVal;

    let classe="";
    if(imcVal<22) classe="Desnutrição";
    else if(imcVal<=27) classe="Normal";
    else classe="Risco";

    document.getElementById("classImc").value=classe;

    calcularICN();
  }
}

function calcularICN(){

  const mna=parseFloat(document.getElementById("mna").value)||0;
  const nrs=parseFloat(document.getElementById("nrs").value)||0;
  const imc=parseFloat(document.getElementById("imc").value)||0;

  let imcScore=0;

  if(imc<22) imcScore=2;
  else if(imc<=27) imcScore=1;
  else imcScore=0;

  const icn=(mna*0.4)+(nrs*0.4)+(imcScore*2);

  document.getElementById("icn").value=icn.toFixed(2);

  let classFinal="Normal";
  if(icn>=4) classFinal="Desnutrição";
  else if(icn>=2) classFinal="Risco";

  document.getElementById("classificacaoFinal").value=classFinal;
}

document.getElementById("mna").addEventListener("input",calcularICN);
document.getElementById("nrs").addEventListener("input",calcularICN);

function salvarAvaliacao(){

  const registro={
    nome:document.getElementById("nome").value,
    data:document.getElementById("dataAvaliacao").value,
    score:parseFloat(document.getElementById("icn").value)||0,
    classificacao:document.getElementById("classificacaoFinal").value
  };

  const lista=JSON.parse(localStorage.getItem("avaliacoes"))||[];
  lista.push(registro);
  localStorage.setItem("avaliacoes",JSON.stringify(lista));

  alert("Avaliação salva com sucesso e integrada ao Dashboard.");
}

function gerarPDF(){

  html2canvas(document.querySelector(".container")).then(canvas=>{

    const imgData=canvas.toDataURL("image/png");
    const pdf=new jspdf.jsPDF("p","mm","a4");

    const largura=210;
    const altura=(canvas.height*largura)/canvas.width;

    pdf.addImage(imgData,"PNG",0,0,largura,altura);
    pdf.save("Ficha_Clinica_ILPI.pdf");
  });
}

</script>

</body>
</html>
