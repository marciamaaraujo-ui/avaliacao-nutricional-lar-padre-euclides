<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <title>Avalia√ß√£o Nutricional - Lar Padre Euclides</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="navbar">
        <img src="logo.png" alt="Logo" style="height: 60px; margin-right: 30px;">
        <a href="index.html">Nova Avalia√ß√£o</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="ficha-completa.html">Ficha Cl√≠nica</a>
        <a href="exames-laboratoriais.html">Exames</a>
    </div>

    <div class="container">
        <header>
            <h1>Avalia√ß√£o Nutricional Integrada</h1>
            <p>Sincroniza√ß√£o MNA, NRS-2002 e Diagn√≥stico PES</p>
        </header>

        <form id="formAvaliacao">
            <section>
                <h3>1. Identifica√ß√£o do Residente</h3>
                <div class="grid">
                    <div><label>Nome Completo</label><input type="text" id="nome" required></div>
                    <div><label>Sexo</label><select id="sexo" onchange="executarCalculos()"><option value="F">Feminino</option><option value="M">Masculino</option></select></div>
                    <div><label>Data de Nascimento</label><input type="date" id="dataNasc" onchange="atualizarIdade()"></div>
                    <div><label>Data de Admiss√£o</label><input type="date" id="dataAdmissao"></div>
                    <div><label>Idade Atual</label><input type="text" id="idade_display" readonly></div>
                    <input type="hidden" id="idade_val">
                </div>
            </section>

            <section style="background: #f0f7ff; border: 2px solid var(--secondary-color);">
                <h3>Dados Compartilhados (Unifica√ß√£o)</h3>
                <div class="grid">
                    <div><label>Redu√ß√£o Ingesta (3m)</label><select id="com_ingesta" onchange="executarCalculos()"><option value="2">Sem redu√ß√£o</option><option value="1">Moderada</option><option value="0">Grave</option></select></div>
                    <div><label>Perda de Peso (3m)</label><select id="com_perda_peso" onchange="executarCalculos()"><option value="0">Sem perda</option><option value="6">Sim, 5-10%</option><option value="11">Sim, > 10%</option></select></div>
                    <div><label>Tempo da Perda (meses)</label><select id="com_tempo_perda" onchange="executarCalculos()"><option value="3">3 meses</option><option value="2">2 meses</option><option value="1">1 m√™s</option></select></div>
                </div>
            </section>

            <section>
                <h3>3. Antropometria e Composi√ß√£o</h3>
                <div class="grid">
                    <div><label>Peso (kg)</label><input type="number" step="0.1" id="peso" oninput="executarCalculos()"></div>
                    <div><label>Altura Real (m)</label><input type="number" step="0.01" id="altura" oninput="executarCalculos()"></div>
                    <div><label>Alt. Joelho (cm)</label><input type="number" step="0.1" id="altJoelho" oninput="executarCalculos()"></div>
                </div>
                <div class="grid">
                    <div><label>IMC</label><input type="text" id="imc" readonly></div>
                    <div><label>CP Ajustada (Prado)</label><input type="text" id="cpAjustada" readonly></div>
                </div>
                <div class="grid">
                    <div><label>Circ. Bra√ßo (cm)</label><input type="number" id="circBraco" oninput="executarCalculos()"></div>
                    <div><label>Circ. Panturrilha (cm)</label><input type="number" id="circPanturrilha" oninput="executarCalculos()"></div>
                </div>
            </section>

            <section>
                <h3>4. Rastreamento Nutricional</h3>
                <div class="grid">
                    <div>
                        <label>MNA (Quest√µes G-R)</label>
                        <select id="mna_g" onchange="executarCalculos()"><option value="1">Casa pr√≥pria</option><option value="0">Institui√ß√£o</option></select>
                        <input type="hidden" id="mna_a"><input type="hidden" id="mna_b"><input type="hidden" id="mna_f">
                        <input type="hidden" id="mna_c" value="2"><input type="hidden" id="mna_d" value="2"><input type="hidden" id="mna_e" value="2">
                        <input type="hidden" id="mna_h" value="1"><input type="hidden" id="mna_i" value="1"><input type="hidden" id="mna_j" value="2">
                        <input type="hidden" id="mna_k" value="1"><input type="hidden" id="mna_l" value="1"><input type="hidden" id="mna_m" value="1">
                        <input type="hidden" id="mna_n" value="2"><input type="hidden" id="mna_o" value="2"><input type="hidden" id="mna_p" value="2">
                        <input type="hidden" id="mna_q" value="1"><input type="hidden" id="mna_r" value="1">
                    </div>
                    <div>
                        <label>Gravidade Doen√ßa (NRS)</label>
                        <select id="nrs_gravidade" onchange="executarCalculos()"><option value="0">Normal</option><option value="1">Leve</option><option value="2">Moderada</option><option value="3">Grave</option></select>
                        <input type="hidden" id="nrs_status">
                    </div>
                </div>
                <div style="background:#eef9f1; padding:20px; border-radius:10px;">
                    <strong>MNA Score: <span id="mna_score">0</span> pts</strong> | 
                    <strong>NRS Score: <span id="nrs_score">0</span> pts</strong>
                </div>
            </section>

            <section>
                <h3>5. Diagn√≥stico Final e PES</h3>
                <div class="grid">
                    <div><label>ICN Final</label><input type="text" id="icn" readonly style="font-weight:bold; color:var(--primary-color);"></div>
                    <div><label>Status Risco</label><input type="text" id="classIcn" readonly style="font-weight:bold;"></div>
                </div>
                <textarea id="parecer" rows="6" style="margin-top:20px;"></textarea>
            </section>

            <button type="button" class="btn-save" onclick="processarSalvamento()">üíæ SALVAR NO PRONTU√ÅRIO</button>
        </form>
    </div>

    <script src="app.js"></script>
    <script>
        function atualizarIdade() {
            const data = document.getElementById("dataNasc").value;
            const idade = calcularIdade(data);
            document.getElementById("idade_display").value = idade + " anos";
            document.getElementById("idade_val").value = idade;
            executarCalculos();
        }

        function executarCalculos() {
            const peso = getNum("peso");
            let altura = getNum("altura");
            const aj = getNum("altJoelho");
            const idade = parseInt(document.getElementById("idade_val").value) || 0;
            const sexo = document.getElementById("sexo").value;

            if (altura === 0 && aj > 0 && idade > 0) altura = estimarAltura(aj, idade, sexo);

            if (peso > 0 && altura > 0) {
                const imcVal = peso / (altura * altura);
                document.getElementById("imc").value = imcVal.toFixed(2);
                
                // Unifica√ß√£o
                sincronizarProtocolos(imcVal, getNum("com_perda_peso"), getNum("com_tempo_perda"), getNum("com_ingesta"));
                document.getElementById("mna_a").value = document.getElementById("com_ingesta").value;
                document.getElementById("mna_b").value = document.getElementById("com_perda_peso").value > 0 ? 0 : 3;

                const mnaT = calcularSomaMNA();
                const nrsT = calcularSomaNRS(idade);
                const icnT = calcularICN(mnaT, nrsT, imcVal);
                const cpA = ajustarCP(getNum("circPanturrilha"), imcVal);

                document.getElementById("mna_score").innerText = mnaT;
                document.getElementById("nrs_score").innerText = nrsT;
                document.getElementById("cpAjustada").value = cpA.toFixed(1) + " cm";
                document.getElementById("icn").value = icnT.toFixed(1);
                document.getElementById("classIcn").value = classificarICN(icnT);
                document.getElementById("parecer").value = gerarParecerPES(mnaT, nrsT, classificarICN(icnT), imcVal, cpA, sexo);
            }
        }

        function processarSalvamento() {
            const nome = document.getElementById("nome").value;
            if(!nome) return alert("Insira o nome!");
            const aval = { data: new Date().toLocaleDateString(), nome: nome, icn: document.getElementById("icn").value, classIcn: document.getElementById("classIcn").value, parecer: document.getElementById("parecer").value };
            salvarAvaliacao(nome, aval);
            alert("Guardado com sucesso!");
        }
    </script>
</body>
</html>
