<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Avalia√ß√£o - Painel Nutricional</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .photo-container { display: flex; flex-direction: column; align-items: center; border: 2px dashed var(--border-color); padding: 20px; border-radius: 15px; background: var(--bg-input); }
        #previewFoto { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); display: none; margin-bottom: 10px; }
        .highlight-box { background: #eef2f7; padding: 10px; border-radius: 8px; font-size: 0.85rem; border-left: 4px solid var(--secondary-color); margin-top: 5px; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="nav-container">
            <img src="logo.png" alt="Logo" class="nav-logo">
            <div class="nav-links">
                <a href="index.html" class="nav-link home-btn">Nova Avalia√ß√£o</a>
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="ficha-completa.html" class="nav-link">Ficha Cl√≠nica</a>
                <a href="exames-laboratoriais.html" class="nav-link">Exames</a>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Nova Avalia√ß√£o Nutricional</h1>
            <p>Identifica√ß√£o, Antropometria e Triagens Cl√≠nicas</p>
        </header>

        <section>
            <h3>1. Perfil do Residente</h3>
            <div style="display: grid; grid-template-columns: 1fr 3fr; gap: 30px;">
                <div class="photo-container">
                    <img id="previewFoto" src="#" alt="Foto">
                    <label for="fotoInput" style="cursor: pointer; color: var(--secondary-color); font-weight: bold;">üì∑ Anexar Foto</label>
                    <input type="file" id="fotoInput" accept="image/*" onchange="previewImagem(event)" style="display: none;">
                </div>
                <div class="grid">
                    <div style="grid-column: span 2;"><label>Nome Completo</label><input type="text" id="nomeResidente"></div>
                    <div><label>Nascimento</label><input type="date" id="dataNasc" onchange="atualizarDados()"></div>
                    <div><label>Idade Atual</label><input type="text" id="res_idade" readonly></div>
                    <div><label>Data Admiss√£o</label><input type="date" id="dataAdmissao"></div>
                    <div><label>Sexo</label><select id="sexo" onchange="atualizarDados()"><option value="F">Feminino</option><option value="M">Masculino</option></select></div>
                </div>
            </div>
        </section>

        <section>
            <h3>2. Antropometria (Ajustes NHANES / Prado 2022)</h3>
            <div class="grid">
                <div><label>Peso (kg)</label><input type="number" id="peso" step="0.1" oninput="atualizarDados()"></div>
                <div><label>Altura(m)</label><input type="number" id="altura" step="0.01" oninput="atualizarDados()"></div>
                 <div><label>Altura do Joelho (AJ cm)</label><input type="number" id="aj" step="0.1" oninput="atualizarDados()"></div>
                <div><label>Circ. Bra√ßo (CB cm)</label><input type="number" id="cb" step="0.1" oninput="atualizarDados()"></div>
                <div><label>Circ. Panturrilha (CP cm)</label><input type="number" id="cp" step="0.1" oninput="atualizarDados()"></div>
                <div>
                    <label>CP Ajustada</label>
                    <input type="text" id="cp_ajustada" readonly>
                    <div id="msgCP" class="highlight-box" style="display:none;"></div>
                </div>
            </div>
        </section>

        <section>
            <h3>3. Triagem MNA (A-R)</h3>
            <div class="grid">
                <div><label>A. Apetite (0-2)</label><select id="mna_a"><option value="2">2</option><option value="1">1</option><option value="0">0</option></select></div>
                <div><label>B. Perda Peso (0-3)</label><select id="mna_b"><option value="3">3</option><option value="2">2</option><option value="1">1</option><option value="0">0</option></select></div>
                <div style="display:none;">
                    <input id="mna_c" value="2"> <input id="mna_d" value="2"> <input id="mna_e" value="2">
                    <input id="mna_f" value="3"> <input id="mna_g" value="1"> <input id="mna_h" value="1">
                    <input id="mna_i" value="1"> <input id="mna_j" value="2"> <input id="mna_k" value="1">
                    <input id="mna_l" value="1"> <input id="mna_m" value="1"> <input id="mna_n" value="2">
                    <input id="mna_o" value="2"> <input id="mna_p" value="2"> <input id="mna_q" value="1">
                    <input id="mna_r" value="1">
                </div>
            </div>
        </section>

        <section style="background: #f9fbf9; border: 2px solid var(--primary-color);">
            <h3>4. Diagn√≥stico e Grava√ß√£o</h3>
            <div class="grid">
                <div><label>IMC</label><input type="text" id="res_imc" readonly></div>
                <div><label>ICN</label><input type="text" id="res_icn" readonly></div>
            </div>
            <button class="btn-save" onclick="confirmarESalvar()">üíæ Gravar Avalia√ß√£o</button>
        </section>
    </div>

    <script src="app.js"></script>
    <script>
        let fotoBase64 = "";

        function previewImagem(e) {
            const reader = new FileReader();
            reader.onload = () => { document.getElementById('previewFoto').src = reader.result; document.getElementById('previewFoto').style.display = 'block'; fotoBase64 = reader.result; };
            reader.readAsDataURL(e.target.files[0]);
        }

        function atualizarDados() {
            const peso = getNum("peso");
            let altura = getNum("altura");
            const aj = getNum("aj");
            const cp = getNum("cp");
            const sexo = document.getElementById("sexo").value;
            const idade = calcularIdade(document.getElementById("dataNasc").value);

            if(idade > 0) document.getElementById("res_idade").value = idade + " anos";
            if(aj > 0 && idade > 0) { altura = estimarAltura(aj, idade, sexo); document.getElementById("altura").value = altura.toFixed(2); }

            if(peso > 0 && altura > 0) {
                const imc = peso / (altura * altura);
                document.getElementById("res_imc").value = imc.toFixed(2);
                
                const cpAdj = ajustarCP(cp, imc); [cite: 33, 48]
                document.getElementById("cp_ajustada").value = cpAdj.toFixed(1) + " cm";
                
                const msgCP = document.getElementById("msgCP");
                msgCP.style.display = "block";
                const limite = (sexo === "M") ? 34 : 33; [cite: 112]
                msgCP.innerHTML = cpAdj < limite ? "‚ö†Ô∏è <strong>Risco de Sarcopenia</strong>" : "‚úÖ Massa Muscular Normal"; [cite: 112]
            }
        }

        function confirmarESalvar() {
            const nome = document.getElementById("nomeResidente").value;
            if(!nome) return alert("Insira o nome!");
            
            const imc = getNum("peso") / (getNum("altura") * getNum("altura"));
            const mna = 12; // Exemplo: integrar soma completa
            const icn = calcularICN(mna, 1, imc);
            
            const avaliacao = {
                data: new Date().toLocaleDateString('pt-PT'),
                peso: getNum("peso"),
                altura: getNum("altura"),
                imc: imc.toFixed(2),
                icn: icn.toFixed(1),
                classIcn: classificarICN(icn),
                parecer: gerarParecerPES(classificarICN(icn), imc, ajustarCP(getNum("cp"), imc), document.getElementById("sexo").value, mna, 1)
            };

            const banco = obterBanco();
            if(!banco[nome]) banco[nome] = { perfil: {}, avaliacoes: [] };
            banco[nome].perfil = { foto: fotoBase64, admissao: document.getElementById("dataAdmissao").value, sexo: document.getElementById("sexo").value };
            banco[nome].avaliacoes.push(avaliacao);
            salvarBanco(banco);
            alert("Sucesso!");
            window.location.href = "dashboard.html";
        }
    </script>
</body>
</html>
