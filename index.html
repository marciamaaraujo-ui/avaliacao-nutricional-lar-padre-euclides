<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalia√ß√£o Nutricional - Lar Padre Euclides</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="navbar">
        <img src="logo.png" alt="Lar Padre Euclides" class="nav-logo" style="height: 60px; margin-right: 30px;">
        <a href="index.html">Nova Avalia√ß√£o</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="ficha-completa.html">Ficha Cl√≠nica</a>
        <a href="exames-laboratoriais.html">Exames</a>
    </div>

    <div class="container">
        <header>
            <h1>Avalia√ß√£o Nutricional Integrada</h1>
            <p>Protocolos MNA, NRS-2002 e Diagn√≥stico PES</p>
        </header>

        <form id="formAvaliacao">
            
            <section>
                <h3>1. Identifica√ß√£o do Residente</h3>
                <div class="grid">
                    <div>
                        <label>Nome Completo</label>
                        <input type="text" id="nome" placeholder="Digite o nome" required>
                    </div>
                    <div>
                        <label>Sexo</label>
                        <select id="sexo" onchange="executarCalculos()">
                            <option value="F">Feminino</option>
                            <option value="M">Masculino</option>
                        </select>
                    </div>
                    <div>
                        <label>Data de Nascimento</label>
                        <input type="date" id="dataNasc" onchange="atualizarIdade()">
                    </div>
                    <div>
                        <label>Data de Admiss√£o</label>
                        <input type="date" id="dataAdmissao">
                    </div>
                    <div>
                        <label>Idade Atual</label>
                        <input type="text" id="idade_display" readonly placeholder="Calculada">
                        <input type="hidden" id="idade_val">
                    </div>
                </div>
            </section>

            <section>
                <h3>2. Antropometria e Estatura Estimada</h3>
                <div class="grid">
                    <div>
                        <label>Peso Atual (kg)</label>
                        <input type="number" step="0.1" id="peso" placeholder="00.0" oninput="executarCalculos()">
                    </div>
                    <div>
                        <label>Altura Real (m)</label>
                        <input type="number" step="0.01" id="altura" placeholder="0.00" oninput="executarCalculos()">
                    </div>
                    <div>
                        <label>Alt. do Joelho (cm)</label>
                        <input type="number" step="0.1" id="altJoelho" placeholder="Estimativa Chumlea" oninput="executarCalculos()">
                    </div>
                </div>
                <div class="grid" style="margin-top: 20px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #eee;">
                    <div>
                        <label>IMC Calculado</label>
                        <input type="text" id="imc" readonly>
                    </div>
                    <div>
                        <label>Classifica√ß√£o (Lipschitz)</label>
                        <input type="text" id="classImc" readonly>
                    </div>
                    <div>
                        <label>Altura Estimada</label>
                        <input type="text" id="altEstimada" readonly>
                    </div>
                </div>
            </section>

            <section>
                <h3>3. Circunfer√™ncias e Massa Muscular (Ajustada)</h3>
                <div class="grid">
                    <div>
                        <label>Circ. Bra√ßo (cm)</label>
                        <input type="number" step="0.1" id="circBraco" oninput="executarCalculos()">
                    </div>
                    <div>
                        <label>Circ. Panturrilha (cm)</label>
                        <input type="number" step="0.1" id="circPanturrilha" oninput="executarCalculos()">
                    </div>
                </div>
                <div class="grid" style="margin-top: 10px;">
                    <div>
                        <label>CB Ajustada (Gordura)</label>
                        <input type="text" id="cbAjustada" readonly>
                    </div>
                    <div>
                        <label>CP Ajustada (Reserva)</label>
                        <input type="text" id="cpAjustada" readonly>
                    </div>
                </div>
            </section>

            <section>
                <h3>4. Rastreio de Risco (MNA & NRS-2002)</h3>
                <div class="grid">
                    <div>
                        <label>Pontos MNA (0-30)</label>
                        <input type="number" step="0.5" id="mna" oninput="executarCalculos()">
                        <input type="text" id="statusMna" readonly style="margin-top: 10px; color: #2980b9; font-weight: bold; border: none; background: transparent;">
                    </div>
                    <div>
                        <label>Pontos NRS-2002 (0-7)</label>
                        <input type="number" id="nrs" oninput="executarCalculos()">
                        <input type="text" id="statusNrs" readonly style="margin-top: 10px; color: #2980b9; font-weight: bold; border: none; background: transparent;">
                    </div>
                </div>
                <div class="grid" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--primary-color);">
                    <div>
                        <label>ICN (√çndice de Conclus√£o)</label>
                        <input type="text" id="icn" readonly style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">
                    </div>
                    <div>
                        <label>Status de Risco Final</label>
                        <input type="text" id="classIcn" readonly style="font-size: 1.2rem; font-weight: bold;">
                    </div>
                </div>
            </section>

            <section>
                <h3>5. Diagn√≥stico Nutricional (Modelo PES)</h3>
                <p style="margin-bottom: 15px; font-size: 0.9rem; color: #666;">Gerado automaticamente com base nos dados acima.</p>
                <textarea id="parecer" rows="6" placeholder="O diagn√≥stico aparecer√° aqui..."></textarea>
            </section>

            <button type="button" class="btn-save" onclick="processarSalvamento()">
                üíæ SALVAR AVALIA√á√ÉO NO PRONTU√ÅRIO
            </button>

        </form>
    </div>

    <script src="app.js"></script>
    <script>
        // Atualiza a idade quando a data de nascimento muda
        function atualizarIdade() {
            const data = document.getElementById("dataNasc").value;
            const idade = calcularIdade(data);
            document.getElementById("idade_display").value = idade + " anos";
            document.getElementById("idade_val").value = idade;
            executarCalculos();
        }

        // Executa toda a l√≥gica de c√°lculos e automa√ß√£o de texto
        function executarCalculos() {
            const peso = getNum("peso");
            let altura = getNum("altura");
            const aj = getNum("altJoelho");
            const idade = parseInt(document.getElementById("idade_val").value) || 0;
            const sexo = document.getElementById("sexo").value;
            const mna = getNum("mna");
            const nrs = getNum("nrs");

            // Estimativa de altura por Knee Height (Chumlea)
            if (altura === 0 && aj > 0 && idade > 0) {
                altura = estimarAltura(aj, idade, sexo);
                document.getElementById("altEstimada").value = altura.toFixed(2) + " m";
            } else {
                document.getElementById("altEstimada").value = "";
            }

            if (peso > 0 && altura > 0) {
                const imcVal = peso / (altura * altura);
                document.getElementById("imc").value = imcVal.toFixed(2);
                document.getElementById("classImc").value = classificarIMC(imcVal);

                // Ajustes de Circunfer√™ncia (Prado et al. 2022)
                const cpAdj = ajustarCP(getNum("circPanturrilha"), imcVal);
                const cbAdj = ajustarCB(getNum("circBraco"), imcVal, sexo);
                document.getElementById("cpAjustada").value = cpAdj.toFixed(1) + " cm";
                document.getElementById("cbAjustada").value = cbAdj.toFixed(1) + " cm";

                // Classifica√ß√µes de Risco Individuais
                const sMna = classificarMNA(mna);
                const sNrs = classificarNRS(nrs);
                document.getElementById("statusMna").value = "MNA: " + sMna;
                document.getElementById("statusNrs").value = "NRS: " + sNrs;

                // C√°lculo do √çndice de Conclus√£o Nutricional (ICN)
                const icnVal = calcularICN(mna, nrs, imcVal);
                const sIcn = classificarICN(icnVal);
                document.getElementById("icn").value = icnVal.toFixed(1);
                document.getElementById("classIcn").value = sIcn;

                // Cor de destaque para o Risco Final
                document.getElementById("classIcn").style.color = (sIcn === "Alto Risco Cl√≠nico") ? "red" : "green";

                // Gera√ß√£o Autom√°tica do Parecer PES
                document.getElementById("parecer").value = gerarParecerPES(sMna, sNrs, sIcn, imcVal, cpAdj, sexo);
            }
        }

        // Salva os dados no LocalStorage
        function processarSalvamento() {
            const nome = document.getElementById("nome").value;
            if (!nome) {
                alert("Por favor, preencha o nome do residente antes de salvar.");
                return;
            }

            const avaliacao = {
                data: new Date().toISOString().split('T')[0],
                dataAdmissao: document.getElementById("dataAdmissao").value,
                nome: nome,
                imc: document.getElementById("imc").value,
                icn: document.getElementById("icn").value,
                classIcn: document.getElementById("classIcn").value,
                parecer: document.getElementById("parecer").value
            };

            salvarAvaliacao(nome, avaliacao);
            alert("Avalia√ß√£o de " + nome + " guardada com sucesso!");
        }
    </script>
</body>
</html>
